- name: download OW2 key
  get_url: url=http://lemonldap-ng.org/_media/rpm-gpg-key-ow2 dest=/root/rpm-gpg-key-ow2 sha256sum=b3170d6400502baed0b3b6288d4e250da60999b0435709be50ebd380a9e4bca9
  register: ow2

- name: trust OW2 key for rpms
  shell: rpm --import /root/rpm-gpg-key-ow2
  when: ow2.changed

- name: Copy LemonLDAP rpm repository
  copy: src=rpm/lemonldap-ng.repo dest=/etc/yum.repos.d/lemonldap-ng.repo

- name: Install some dependancies
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - openldap-clients
    - epel-release
    - mod_ssl

- name: Setup OpenLDAP client configuration file
  template: src={{ item }} dest=/etc/openldap/
  with_fileglob:
    - ../templates/etc/openldap/*

- name: Install LemonLDAP
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - lemonldap-ng
    - lemonldap-ng-fr-doc

- name: Install configuration files (1/3)
  template: src={{ item }} dest=/etc/lemonldap-ng/
  with_fileglob:
    - ../templates/etc/lemonldap-ng/*
  register: c1

- name: Install LemonLDAP configuration files (2/3)
  template: src={{ item }} dest=/var/lib/lemonldap-ng/conf/
  with_fileglob:
    - ../templates/var/lib/lemonldap-ng/conf/*
  register: c2

- name: Install TLS certificates and keys (3/3)
  copy: src={{ item }} dest=/etc/ssl/httpd/ owner=apache group=apache mode=0640
  with_items:
    - certs/sso.cert.pem
    - certs/sso.key-nopass.pem
    - certs/sso-manager.cert.pem
    - certs/sso-manager.key-nopass.pem
    - certs/sso-reload.cert.pem
    - certs/sso-reload.key-nopass.pem
  register: c3

- name: Update SSL configuration file
  copy: src={{ item }} dest=/etc/httpd/conf.d/ owner=apache group=apache mode=0644
  with_items:
    - etc/httpd/conf.d/ssl.conf
  register: c4

- name: Restart apache
  service: name=httpd state=restarted enabled=yes
  when: (c1.changed) or (c2.changed) or (c3.changed) or (c4.changed)
